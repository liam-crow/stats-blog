---
title: "Introduction to AFL Analytics with Useless AFL Stats"
author: "Liam Crowhurst"
date: "2020-07-06"
output: html_document
slug: introduction-to-afl-analysis-with-useless-afl-stats
categories: ['AFL Data Tutorial']
tags: ['Useless AFL Stats','Introduction to R','R']
---

I'm co-admin of a little page on Facebook that caters to a niche audience of AFL statistics nerds known as [Useless AFL Stats](https://www.facebook.com/uselessaflstats), where (founder and co-admin) Aaron and I discover stats that have no relevance to anything at all, and will never be useful to anyone, ever. And that got me thinking, why should I have all the fun finding these nuggets of gold?

I'm a firm believer in open source programming and data, the idea that as much data should be made publicly available as possible to the largest possible audience. After all, 1000 plus brains are going to be more innovative, better at analysing trends, faster at fact checking (and creating useless AFL stats) than just 2.

That's why I'll be taking you on a journey from beginner to expert, to give you the tools to be the master of your own AFL data analysis. Key points will be covered in this first post:
 
* Setup of your coding workspace
  + R installation
  + Rstudio installation and setup
* Basics of R
* Downloading AFL data
* Creating your first useless AFL stat

If you have any questions during this tutorial, you can tweet at me [\@crow_data_sci](https://twitter.com/crow_data_sci). If you've got a useless stat, feel free to tweet at us [\@UselessStatsAFL](https://twitter.com/UselessStatsAFL) or message the page.

Ok, let get into the setup!

# R and RStudio Installation

The program that we'll be using to generate stats is [R](https://www.r-project.org/), a powerful tool commonly used by professional statisticians and data scientists in academia and industry, but we'll be using it to shitpost about AFL stats.

We'll be downloading R from here [https://cran.csiro.au/](https://cran.csiro.au/) and choose the version for your OS. I'd recommend all the default file locations and setup.

We'll also be using RStudio, a Graphical User Interface (GUI) that allows for easier use of the R language. Download the free version here at [https://rstudio.com/products/rstudio/download/](https://rstudio.com/products/rstudio/download/).

Once they've been downloaded, open up your newly installed RStudio program. It should automatically find R and open up an interface. Think of R as the frame, steering wheel and engine of a car. You can get pretty far with just that, but RStudio completes the car, adding all the bells and whistles for a more comfortable journey. God that's a terrible analogy.

## Basics of R

Anyway, you should see a screen and tab named 'Console'. This is where all the the commands get executed, lets try a couple out.

```{r}
1+1
2*4
3^3
```

Nice, what you'll see is that the answer has been calculated and result has been produced on the next line.

Let's save these results, we may want to use them later. In R we use an assignment command `<-`, which looks like a backwards arrow. You can assign a result to any string of characters. You can also assign characters (like names, teams, locations, etc) to variables too.

```{r}
a <- 1+1
b <- 2*4
c <- 3^3
first_name <- 'John'
```

If you look at the 'Environment' tab in the top right section, we can see our newly created variables, which we can use later on. Variables can be used in commands with each other too. You can't add strings to numbers though.

```{r}
a + b * c
```

Another important concept are vectors, a data structure that can hold multiple values. We use `c()` to denote a vector and we can insert multiple values.

```{r}
d <- c(3,7,8,2)
teams <- c('WCE','Freo','Geel')
d
d*2
d[3]
teams[2]
```

We can multiply and add to vectors and use square brackets to pull out certain indexes (positions) of the vector. Press the up arrow to cycle backwards through your previous commands.

## Projects

Projects help contain all of your data and files in an easy to maintain structure. We'll create one for all of our AFL data analysis.

1. Click the dropdown menu in the top right corner
2. New project (and save)
3. New Directory
4. New Project
5. Name it (`AFL_Scripts` or something similar)

This initialises your new project, and we'll do all our analysis in this project. Use the command `getwd()` to find out the file path of this directory. You should see something similar to `C:/Users/your_name/Documents/AFL_Scripts`.

## Scripts

Scripts are an easy way to store commands that you want to come back to later, and all of our data analysis will be written in scripts. To create a new script:

1. File (top left)
2. New File
3. R Script

Writing commands in the script and pressing enter will not execute the command, but will take you to a newline. To execute a line, use `Ctrl` + `Enter`. Press `Ctrl` + `S`to save your script, and you should see it appear in the 'Files' tab on the left hand side.

# Let's get into some AFL Analytics!

In our new script, we first need to install some packages and load them into our workspace by executing the following commands.

## Installing packages
```{r, eval = F}
install.packages("devtools") #allows us to download from github
install.packages("dplyr")    #data manipulation tools
install.packages("tidyr")    #more data manipulation tools
install.packages("snakecase")#data cleaning tool
devtools::install_github("jimmyday12/fitzRoy") #package that loads afltables into R
```

## Loading packages

```{r, warning=F, message=F}
library(dplyr)
library(tidyr)
library(snakecase)
library(fitzRoy)
```

Here's another analogy, think of `install.packages` as a light bulb and `library` as a switch. You only need to install a package once (unless you update R), and can use the `library` function to turn them on when needed.

Side note using a hash (`#`) is a programming technique called commenting. Anything after a `#` will not be run and it allows the programmer to add notes, like what a certain line or function does.

# Loading in AFL data

Now that we have everything set up, we can dive right in to the stats. We are going to load in data from [afltables.com](https://afltables.com/afl/afl_index.html) using [fitzRoy](https://github.com/jimmyday12/fitzRoy), and R package put together by [James Day](https://twitter.com/jamesday87) that contains most of the match data in a consistent structure.

Lets load in all the data from the year 2000 onwards and assign it to a variable.

```{r}
afltables <- get_afltables_stats(start_date = '2000-01-01')
# afltables <- get_afltables_stats() will pull in all the data from 1897
```

Now that the data is loaded into our workspace, you can see in the 'Environment' tab that we have 172 thousand rows (observations) and 59 columns (variables). We can confirm this with the `dim` (short for dimensions) function. Loading in the data from 1897 will have over 600k rows.

```{r}
dim(afltables) #rows by columns
```

Lets use the head command, which shows the top 6 or so rows of our dataset.

```{r}
head(afltables)
```

And use the command `names` to check the column names, to help get a sense of what this data holds.

```{r}
names(afltables)
```

This next step I like to include cleans up some of the naming used, makes it more consistent format that is less likely to break a function later down the line.

```{r}
#rename all the columns to a snakecase format
names(afltables) <- to_snake_case(names(afltables))
names(afltables) # now the column headers are in lowercase and have dots replaced with underscores
```

# Useless AFL Stat
Lets work towards two stats:

> Who has the highest disposal tally equal to their jumper number?

and:

> Which season has the highest accuracy?

## Selecting columns

Now that the data is loaded and in a format we can easily manipulate, lets take a look at some basic functions. `dplyr` has built in functions to make this process as painless as possible. Firstly, lets look at `select`, and function that keeps the columns we want to investigate. Also we are going to be making use of `%>%`, known as a pipe, to channel our data through various functions. A shortcut for the command is `Ctrl` + `Shift` + `m`.

```{r}
afltables %>% 
  select(season, round, date, id, first_name, surname, jumper_no, kicks, handballs)
```

## Combining (mutating) columns

Nice, now we've got the data want to investigate we can use a technique using a function called `mutate`. Whats interesting is this data source doesn't have a disposals count column, but we can easily recreate it by adding handballs to kicks with one line of code. 

```{r}
afltables %>% 
  select(season, round, date, id, first_name, surname, jumper_no, kicks, handballs) %>% 
  mutate(disposals = kicks + handballs) #name of our new column goes on the left hand side
```

## Filtering our data

A staple of Useless AFL Stats is the use of the jumper number, mainly because its arbitrary and should have no effect on the game, but nonetheless makes for a great stat. Lets find all the times the disposal count was equal to the jumper number. We can achieve this by using the `filter` function.

```{r}
afltables %>% 
  select(season, round, date, id, first_name, surname, jumper_no, kicks, handballs) %>% 
  mutate(disposals = kicks + handballs) %>% 
  filter(disposals == jumper_no)
```

## Arranging by a column

Ok, so we have all the occurrences when jumper no. was equal to disposals, what was the largest? We can use the `arrange` function on a column to sort by ascending or descending order. The default arrangement for a columns is ascending (smallest at the top to biggest), so we'll wrap the column in `desc()` to get the descending order.

```{r}
afltables %>% 
  select(season, round, date, id, first_name, surname, jumper_no, kicks, handballs) %>% 
  mutate(disposals = kicks + handballs) %>% 
  filter(disposals == jumper_no) %>% 
  arrange(desc(jumper_no))
```

And there we have it, your first useless AFL stat. You should see Tom Rockliff up the top with 2 games of 38 disposals wearing the number 38. Useless.

## Group by and Summarise 

Grouping is a powerful tool we use to group certain values in columns. An example of this would be season, where each year is essentially its own category, and we can run commands that (for example) take the average amount of goals per season. Lets put this into practice with a simple example based off data we already have answering the following question:

> Which season has the highest accuracy?

Lets pull in the data we need to create this stat. We need to sum the total goals and behinds per season.

```{r}
afltables %>% 
  select(season, goals, behinds) %>% 
  group_by(season) %>% 
  summarise(
    sum_g = sum(goals),
    sum_b = sum(behinds),
    .groups = 'drop'
  )
```

Now that we have the total counts per season, we can use `mutate` to calculate accuracy, which is $\dfrac{Goals}{Shots}$. We are also going to arrange the result to see which season has the highest accuracy.

```{r}
afltables %>% 
  select(season, goals, behinds) %>% 
  group_by(season) %>% 
  summarise(
    sum_g = sum(goals),
    sum_b = sum(behinds),
    .groups = 'drop'  #we also need to drop the grouping after running the command
  ) %>% 
  mutate(
    accuracy = sum_g/(sum_g+sum_b)*100
  ) %>% 
  arrange(desc(accuracy))
```

Nice, we can see that the year 2000 has the highest accuracy. Another question we might ask is which round in each season has the highest accuracy? We can group by a second variable, round.

```{r}
afltables %>% 
  select(season, round, goals, behinds) %>% 
  group_by(season, round) %>% 
  summarise(
    sum_g = sum(goals),
    sum_b = sum(behinds),
    .groups = 'drop'  #we also need to drop the grouping after running the command
  ) %>% 
  mutate(
    accuracy = sum_g/(sum_g+sum_b)*100
  ) %>% 
  arrange(desc(accuracy))
```

Nice, 2005 Elimination finals games were at nearly 70% kicking accuracy. `group_by` and `summarise` work really well together, and you can switch out `sum` with `mean` for the average, or `max` and `min` for the maximum and minimum in each group. The possibilities are endless.

# Conclusion

Thanks for making it this far, hopefully its given you a taste of the potential insights (useful or useless) that R and AFL have to offer. This is hopefully the first in a series of tutorials about AFL analytics in R. You can contact us on twitter or Facebook, let us know what you found interesting, insightful, difficult, any other types of stats you'd like to see recreated in upcoming posts.

PS Aaron and I are looking for another admin for the creation of stats, answering questions so please let us know if you're interested.


